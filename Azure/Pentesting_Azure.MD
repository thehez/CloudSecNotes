Pentesting Azure Environments

- [1. Scoping and Planning](#1-scoping-and-planning)
  - [1.1. Understanding Azure Deployment Methods](#11-understanding-azure-deployment-methods)
    - [1.1.1. Azure Service Management](#111-azure-service-management)
      - [1.1.1.1. ASM Authentication](#1111-asm-authentication)
    - [1.1.2. Azure Resource Manager](#112-azure-resource-manager)
      - [1.1.2.1. RBAC](#1121-rbac)
      - [1.1.2.2. Service Principals](#1122-service-principals)
    - [1.1.3. Migrating ASM to ARM](#113-migrating-asm-to-arm)
- [Obtaining Credentials](#obtaining-credentials)
  - [Phishing](#phishing)
  - [Searching Documents](#searching-documents)
  - [ARM Profile Tokens](#arm-profile-tokens)
  - [Mimikatz](#mimikatz)
  - [Password Guessing](#password-guessing)

# 1. Scoping and Planning

Considerations when scoping an Azure assessment:
- Target subscription identifier(s)
- Any IPs or hostnames of the services to target
- A list of service types in the subscription and related IPs
- Any exposed services or other security concerns
- The goals and desired outcome of the engagement

Typically you don't need to inform Microsoft to perform a security assessment against your own subscriptions in Azure. However if applicable you can give Microsoft advance notification of pentesting.

Care should be taken not to pentest the underlying Microsfot Azure Service Fabric. However, if you find a flaw in Azure itself, report it to Microsoft. Microsoft is fairly strict with this last point—you are required to report any identified Azure Fabric vulnerabilities within 24 hours and must not disclose them elsewhere for 90 days. You may be able to submit these findings to the Microsoft Online
Services Bug Bounty program. To find out more about the Bug Bounty program, see https://technet.microsoft.com/en-us/security/dn800983/.

## 1.1. Understanding Azure Deployment Methods
Azure has two authentication and permissions models:

- Azure Service Management (ASM) - a legacy model released with the initial versions of Azure
- Azure Resource Manager (ARM) - the recent role based system in use now

Note - Both models can coexist in one subscription but each resource can only use one of the models. Therefore, if you
authenticate to the legacy portal, you’ll only be able to see “classic” Azure services. Running the newer Azure PowerShell commands will typically give you access only to modern resources. The upshot is that hacking one user’s account may provide access to only a fraction of the services running under a subscription. Therefore, it’s
crucial to attempt to compromise both models in any target subscription to ensure a complete assessment.

### 1.1.1. Azure Service Management

The Azure Service Management model uses a simple authorization mechanism with only three possible roles: 
- Service Administrator (most privileged in terms of services)
- Account Administrator (Can change who is assigned to service administrator but cannot modify resources)
- Co-Administrator (similar to service administrator but cannot amend role assignments of admins)

Because Co-Administrators are essentially equivalent to Service Administrators, and both have full control over any ASM-created resource, once you obtain ASM access to an Azure subscription, all ASM resources are entirely under your control.

#### 1.1.1.1. ASM Authentication
ASM supports username & password pairs and x.509 certificate based authentication known as management certificates for programatic access. Though certificates are more secure than passwords secure certificate management is a common issue including:
- certificate reuse
- lack of revocation
- improper storage
- etc

### 1.1.2. Azure Resource Manager
Rather than integrate new changes into the existing ASM management portal and APIs, Microsoft launched Azure Resource Manager as a direct replacement.

Notable changes introduced in ARM include the following:

- Azure Portal
- Role-based access control
- Removal of management certificates
- Addition of service principals
- Ability to manage a group of resources as one unit
- New PowerShell cmdlets
- Templates to quickly deploy complex services

#### 1.1.2.1. RBAC
ARM offers numerous roles which can be assigned to users both at a subscription level and on a per-resource basis.

The most common roles are:
- Owner (full control)
- Contributor (all rights except the ability to change permissions)
- Reader (read-only control)
- User Access Administrator (ability to edit permissions only)
- Other service-specific roles such as SQL DB Contributor and Website Contributor permit the Owner to limit administrator level privileges to specific services

#### 1.1.2.2. Service Principals
Similar to service accounts in an on-premises server, Service principals allow an application to run under an account not associated with a regular user to access other cloud resources. 

Because service principals are used for software, scripts, and automation, these accounts can use either passwords (automatically generated and referred to as a “Client Secret") or certificates to authenticate, though their
configuration and use differ from ASM management certificates.

### 1.1.3. Migrating ASM to ARM
Because ARM offers several security advantages over ASM, you should migrate any existing ASM-based services to ARM. To do so, download the tools MigAz and ASM2ARM from GitHub. Microsoft also has several articles on ARM migration posted at https://docs.microsoft.com/en-us/azure/virtual-machines/windows/Migration-classic-resource-manager-overview/.

# Obtaining Credentials
You can try to find or compromise credentials in several locations

## Phishing
Phishing and Spear Phishing can be used to capture user credentials, the downside is that it's not possible to capture service account credentials.

## Searching Documents
Credentials such as tokens or passwords may be stored in unencrypted files on a users system.

When a user logs in with the `az login` command a token is stored within the `$HOME/.azure` directory

Search browsers for stored passwords and look for certificates and .pfx files that may contains ASM certificates.

## ARM Profile Tokens
Azure provides an ARM PowerShell cmdlet to save an Azure credential as a profile: `Save-AzureRmProfile`
Save-AzureRmProfile. 

These profiles are just JSON files, and the developer can choose to store them wherever they like. Inside these JSON files is a token, which is a stored representation of the saved credential. To use it, simply run the `Select-AzureRmProfile` cmdlet and specify the JSON file using the `-Path` parameter.

There is no default storage name or location for these files so may need to find and grep files to find valid tokens:
Search terms:
- TokenCache - the variable in the file that stores the actual credential.
- Tenant
- PublishSettingsFileUrl
- ManagementPortalUrl

## Mimikatz
https://github.com/gentilkiwi/mimikatz/

Mimikatz works by identifying the running Local Security Authority Subsystem Service (LSASS) on a Windows system, attaching to it, and siphoning secrets out of its memory.
It requires administrative access to the host which could be gained through privilege escalation or social engineering etc.

Process:
- launch elevated command prompt
- enable debugging - `mimikatz # privilege::debug`
- dump passwords - `sekurlsa::logonpasswords`

Defence - Use credential guard https://technet.microsoft.com/en-us/itpro/windows/keep-secure/credential-guard/

## Password Guessing
Password guessing, password spraying and brute-force techniques may have limited luck depending on password and mfa requirements.

When guessing, try to find some public endpoint that will validate the user’s credentials and report the result quickly. Corporate webmail sites and virtual private network (VPN) endpoints might be good options. A site that
does not rate-limit logon attempts and does not lock out user accounts is useful to attackers.