# Pentesting Kubernetes

- [Pentesting Kubernetes](#pentesting-kubernetes)
  - [Attack Surface](#attack-surface)
  - [Enumeration](#enumeration)
    - [Search repositories for secrets/credentials](#search-repositories-for-secretscredentials)
    - [Common Ports](#common-ports)
      - [Kubernetes API](#kubernetes-api)
      - [ETCD](#etcd)
      - [Kubelet](#kubelet)
  - [Methodology checks](#methodology-checks)

## Attack Surface
https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/

Kubernetes attack entrypoints:
- Application - Attacker able to compromise a vulnerability within an application to gain an initial foothold via a pod into the cluster
- Authenticated attackers / malicious insiders - Attacker gains authenticated access by accessing leaked/compromised kubeconfigs or cloud provider credentials such as those leaked in source code.
- Exposed endpoint - Misconfigured ingress, exposed services or Kube-API providing access to cluster resources
- Compromised Images - Backdoored/Vulnerable images from a private or public repository

access to secrets to get access tokens
is a secret managment solution like vault in place - can you access a token that has permissions in vault - check if vault is misconfigured to access multiple secrets...

## Enumeration

### Search repositories for secrets/credentials
- https://github.com/ovotech/gitoops
- https://github.com/trufflesecurity/TruffleHog
- https://github.com/zricethezav/gitleaks
- https://github.com/michenriksen/gitrob

### Common Ports
By default, kubernetes components listen on the following ports:

- 443/TCP (Kubernetes API Port)
- 6443/TCP (Kubernetes API Port)
- 8443/TCP (Minikube API Port)
- 8080/TCP (Insecure K8s API Port)
- 10250/TCP (kubelet API)
- 10251/TCP (kube-scheduler)
- 10252/TCP (Controller-manager)
- 2379/TCP (etcd Storage)
- 2380/TCP (etcd Storage)
- 6666/TCP (etcd Storage/etcd Client Server) 	
- 4194/TCP (Container Metrics)
- 9099/TCP (calico-felix/Health Check Calico Server) 	
- 6782-4/TCP (Metrics and Endpoints) 	
- 30000-32767/TCP (NodePort services)

#### Kubernetes API
https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/

By default, the Kubernetes API should block anonymous access however if it is misconfigured you can use `curl` or the `kubectl` command line utility to issue commands. It may also be possible to use brute force tools such as gobuster to discover custom directories
```
curl http(s)://<Kubernetes-Master-Server>:<Port> # format
curl http://localhost:8080/api/v1 # example api directory
kubectl get pods # kubectl example
```

#### ETCD
https://etcd.io/docs/v3.4/dev-guide/interacting_v3/

Access to ETCD should be heavily restricted, however if ETCD is exposed you can use curl and the `etcdctl` binary to interact with it. 
```
curl http://<Kubernetes-Master-Server>:2379
curl http://<Kubernetes-Master-Server>:6666/v2/keys
etcdctl --endpoints=<Kubernetes-Master-Server>:2379 get / --prefix --keys-only
```
If you manage to compromise a TLS certificate and can access ETCD you have effective cluster admin permission as you can read and write all objects within the cluster database
```
etcdctl --endpoints=<Kubernetes-Master-Server >:2379 get / --prefix --keys-only
```

#### Kubelet
https://github.com/cyberark/kubeletctl

The `kubeletctl` tool can be used to scan for nodes with an exposed kubelet API. If your able to find a misconfigured kubelet, the tools will help you run commands on containers, retrieve service account tokens and attempt to gain RCE.


## Methodology checks
Kubernetes version - CVE - kubectl version

check versions

latest/hash images - image pull policy

network segregation - worker to master, API, connect to etcd?

network security - TLS?

Review admission controllers


References and Links

https://www.optiv.com/insights/source-zero/blog/kubernetes-attack-surface

https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/

https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3
