# Pentesting Kubernetes

- [Pentesting Kubernetes](#pentesting-kubernetes)
  - [Attack Surface](#attack-surface)
  - [Unauthenticated Enumeration](#unauthenticated-enumeration)
    - [Search repositories for secrets/credentials](#search-repositories-for-secretscredentials)
    - [Common Ports](#common-ports)
      - [Kubernetes API](#kubernetes-api)
      - [ETCD](#etcd)
      - [Kubelet](#kubelet)
  - [Authenticated Enumeration](#authenticated-enumeration)
    - [Self Subject Review](#self-subject-review)
    - [Enumerate Privileged Accounts](#enumerate-privileged-accounts)
  - [Privilege Escalation](#privilege-escalation)
    - [Secrets](#secrets)
    - [Create Pods/Deployments/Daemonsets](#create-podsdeploymentsdaemonsets)
    - [POD Exec](#pod-exec)
    - [Create Roles/Bindings](#create-rolesbindings)
    - [Account/Group Impersonation](#accountgroup-impersonation)
  - [Container Breakout](#container-breakout)
  - [Methodology checks](#methodology-checks)
  - [Tools and Plugins](#tools-and-plugins)
  - [References and Links](#references-and-links)

## Attack Surface
https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/

Kubernetes attack entrypoints:
- Application - Attacker able to compromise a vulnerability within an application to gain an initial foothold via a pod into the cluster
- Authenticated attackers / malicious insiders - Attacker gains authenticated access by accessing leaked/compromised kubeconfigs or cloud provider credentials such as those leaked in source code.
- Exposed endpoint - Misconfigured ingress, exposed services or Kube-API providing access to cluster resources
- Compromised Images - Backdoored/Vulnerable images from a private or public repository

access to secrets to get access tokens
is a secret managment solution like vault in place - can you access a token that has permissions in vault - check if vault is misconfigured to access multiple secrets...

## Unauthenticated Enumeration
### Search repositories for secrets/credentials
- https://github.com/ovotech/gitoops
- https://github.com/trufflesecurity/TruffleHog
- https://github.com/zricethezav/gitleaks
- https://github.com/michenriksen/gitrob

### Common Ports
By default, kubernetes components listen on the following ports:

- 443/TCP (Kubernetes API Port)
- 6443/TCP (Kubernetes API Port)
- 8443/TCP (Minikube API Port)
- 8080/TCP (Insecure K8s API Port)
- 10250/TCP (kubelet API)
- 10251/TCP (kube-scheduler)
- 10252/TCP (Controller-manager)
- 2379/TCP (etcd Storage)
- 2380/TCP (etcd Storage)
- 6666/TCP (etcd Storage/etcd Client Server) 	
- 4194/TCP (Container Metrics)
- 9099/TCP (calico-felix/Health Check Calico Server) 	
- 6782-4/TCP (Metrics and Endpoints) 	
- 30000-32767/TCP (NodePort services)

#### Kubernetes API
https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/

By default, the Kubernetes API should block anonymous access however if it is misconfigured you may be able to use `curl` or the `kubectl` command line utility to issue commands. It may also be possible to use brute force tools such as `gobuster` to discover custom directories
```
curl http(s)://<Kubernetes-Master-Server>:<Port> # format
curl http://localhost:8080/api/v1 # example api directory
kubectl get pods # kubectl example
```

#### ETCD
https://etcd.io/docs/v3.4/dev-guide/interacting_v3/

Access to ETCD should be heavily restricted, however if ETCD is exposed you can use curl and the `etcdctl` binary to interact with it. 
```
curl http://<Kubernetes-Master-Server>:2379
curl http://<Kubernetes-Master-Server>:6666/v2/keys
etcdctl --endpoints=<Kubernetes-Master-Server>:2379 get / --prefix --keys-only
```
If you manage to compromise a TLS certificate and can access ETCD you have effective cluster admin permission as you can read and write all objects within the cluster database
```
etcdctl --endpoints=<Kubernetes-Master-Server >:2379 get / --prefix --keys-only
```

#### Kubelet
https://github.com/cyberark/kubeletctl

The `kubeletctl` tool can be used to scan for nodes with an exposed kubelet API. If your able to find a misconfigured kubelet, the tools will help you run commands on containers, retrieve service account tokens and attempt to gain RCE.

## Authenticated Enumeration
If you can gain authenticated access to the API you will want to perform some further enumeration of the cluster to discover secrets and attempt to escalate privileges etc:

### Self Subject Review
https://www.mankier.com/1/kubectl-auth-can-i

The Kube API provides a 'SelfSubjectAccessReview' method which can be used to determine the actions an entity can perform within the cluster. You can use the kubectl auth can-i subcommand for quickly querying the API authorization layer to determine if the current user can perform a given action for a given (or all) resources.

Manually:
```
# One liner to list permissions
kubectl auth can-i --list

# Check all actions and resources - checks if admin
kubectl auth can-i '*' '*'

# Common actions and resources
can-i list/get/create secrets/pods/deployements 

# All namespaces
-A

# A given namespace
-n <namespace> 

# Impersonate a user (if allowed what actions can you perform as that entity)
--as <user/service> 
```

Tools:
- https://github.com/corneliusweig/rakkess
- 

### Enumerate Privileged Accounts
In kubernetes roles and permissions are created and assigned seperately, through roles and rolebindings. Roles can either be clusterwide (clusterroles) or namespaced (roles), and the permissions can be assigned clusterwide (clusterrolebinding) or namespaced (rolebinding).

You may be able to view roles and role bindings to discover privileged accounts within the cluster.

Manually:

```
kubectl get clusterroles -o json | jq . | less
kubectl get clusterrolebindings -o json | jq . | less
kubectl get roles -A -o json | jq . | less
kubectl get rolebindings -A -o json | jq . | less
```

Tools:
- https://github.com/cyberark/KubiScan

## Privilege Escalation
Detailed information on the following priv esc vectors can be found in the cyber ark blogs in references.
### Secrets
If you can retrieve secrets you may be able to elevate your privileges or move laterally to another namespace etc by accessing account tokens. Account tokens are stored as base64 encoded JWT values within secrets, if you can access secrets you can retrieve and decode the JWT and ca.crt to impersonate that service account.

Other sensitive information such as SSH keys, OAuth tokens, credentials and URLS for other services may also be stored within kubernetes secrets.

### Create Pods/Deployments/Daemonsets
If you have permission to create pods (directly or through deployments and daemonsets) you can attempt to create a pod and mount a privileged service account to the pod to escalate privileges. 

If there are permissive PSPs (or other policy controls) or you have sufficient privileges you may be able to create a pod that mounts a vulnerable hostpath or assigns extra linux capabilties to the pod to perform a container breakout and access the nodes kubelet to perform elevated actions.

If you are able to deploy a daemonset you will get a copy of the pod on each node (you may have to specify taints and tolerations to get it on certain nodes) if you're able to deploy a vulnerable pod and breakout each node may have different privileges - if you are able to breakout onto a master node or access etcd you will have full access to the cluster.

### POD Exec
### Create Roles/Bindings
If you have the permission to create rolebindings you can assign extra permissions to yourself or entities under your control. You can also create new roles for persistence.

### Account/Group Impersonation
If you have permission to impersonate other accounts they may have more permissions that provide additional privilege escation vectors.


## Container Breakout
For full information regarding container breakout vectors read the information container within: [Pentesting Docker](../Docker/Pentesting_Docker.md)


## Methodology checks
Kubernetes version - CVE - kubectl version

check versions

latest/hash images - image pull policy

network segregation - worker to master, API, connect to etcd?

network security - TLS?

Review admission controllers


## Tools and Plugins

Krew
- access-matrix
- get-all
- graph
- outdated
- rbac-lookup
- starboard
- who-can

## References and Links

https://www.optiv.com/insights/source-zero/blog/kubernetes-attack-surface

https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/

https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3

https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions

https://lobuhisec.medium.com/kubernetes-pentest-recon-checklist-tools-and-resources-30d8e4b69463

